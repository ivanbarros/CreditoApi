# üè¶ API de Consulta de Cr√©ditos Constitu√≠dos

[![.NET](https://img.shields.io/badge/.NET-6.0-512BD4)](https://dotnet.microsoft.com/)
[![PostgreSQL](https://img.shields.io/badge/PostgreSQL-14-336791)](https://www.postgresql.org/)
[![Docker](https://img.shields.io/badge/Docker-Ready-2496ED)](https://www.docker.com/)
[![License](https://img.shields.io/badge/License-MIT-green.svg)](LICENSE)

## üìã Descri√ß√£o

API RESTful desenvolvida em .NET Core 6.0 para gerenciamento e consulta de cr√©ditos constitu√≠dos. O sistema implementa um background service que processa mensagens do Azure Service Bus e armazena os dados em PostgreSQL.

---

## üìë √çndice

### üöÄ In√≠cio R√°pido
- [Tecnologias Utilizadas](#-tecnologias-utilizadas)
- [Pr√©-requisitos](#pr√©-requisitos)
- [Instala√ß√£o R√°pida com Docker](#-executando-com-docker)
- [Instala√ß√£o Local](#-executando-localmente-sem-docker)

### üìñ Documenta√ß√£o da API
- [Endpoints da API](#-endpoints-da-api)
  - [Integrar Cr√©ditos](#1-integrar-cr√©ditos-constitu√≠dos)
  - [Buscar por NFS-e](#2-buscar-cr√©ditos-por-nfs-e)
  - [Buscar por N√∫mero](#3-buscar-cr√©dito-por-n√∫mero)
  - [Health Checks](#4-health-check---self)
- [Modelagem de Dados](#-modelagem-de-dados)
- [Fluxo de Funcionamento](#-fluxo-de-funcionamento)

### üèóÔ∏è Arquitetura e Padr√µes
- [Arquitetura do Projeto](#-arquitetura)
- [Estrutura de Pastas](#estrutura-do-projeto)
- [Padr√µes de Projeto](#-padr√µes-de-projeto-implementados)
- [Princ√≠pios SOLID](#-princ√≠pios-solid-aplicados)
- [Arquitetura CQRS](#-arquitetura-cqrs-vers√£o-20)

### üîß Configura√ß√£o
- [Vari√°veis de Ambiente](#vari√°veis-de-ambiente)
- [Configura√ß√£o do Azure Service Bus](#configura√ß√£o-do-azure-service-bus)
- [Configura√ß√£o do Docker](#-executando-com-docker)

### üß™ Testes
- [Executando Testes](#-executando-os-testes)
- [Testes Implementados](#-testes-implementados)
- [Cobertura de C√≥digo](#com-cobertura-de-c√≥digo)

### üìä Informa√ß√µes do Projeto
- [Tecnologias e Vers√µes](#-tecnologias-e-vers√µes)
- [Diferenciais Implementados](#-diferenciais-implementados)
- [Qualidade do C√≥digo](#-qualidade-do-c√≥digo)



---

## üöÄ Tecnologias Utilizadas

- **.NET Core 6.0** - Framework principal
- **C#** - Linguagem de programa√ß√£o
- **Entity Framework Core** - ORM para acesso a dados
- **PostgreSQL** - Banco de dados relacional
- **Azure Service Bus** - Mensageria para processamento ass√≠ncrono
- **Docker & Docker Compose** - Containeriza√ß√£o
- **MSTest** - Framework de testes unit√°rios
- **Moq** - Biblioteca para mocking em testes
- **Swagger/OpenAPI** - Documenta√ß√£o da API

## üèóÔ∏è Arquitetura

O projeto segue os seguintes padr√µes de design:

- **Repository Pattern** - Abstra√ß√£o da camada de dados
- **Dependency Injection** - Invers√£o de controle
- **Background Service** - Processamento ass√≠ncrono de mensagens
- **DTO Pattern** - Separa√ß√£o entre modelos de dom√≠nio e transfer√™ncia
- **SOLID Principles** - C√≥digo limpo e manuten√≠vel

### Estrutura do Projeto

```
CreditoAPI/
‚îú‚îÄ‚îÄ Controllers/          # Controladores da API
‚îú‚îÄ‚îÄ Models/              # Entidades do dom√≠nio
‚îú‚îÄ‚îÄ DTOs/                # Objetos de transfer√™ncia de dados
‚îú‚îÄ‚îÄ Data/                # Contexto do Entity Framework
‚îú‚îÄ‚îÄ Repositories/        # Camada de acesso a dados
‚îú‚îÄ‚îÄ Services/            # L√≥gica de neg√≥cio
‚îú‚îÄ‚îÄ BackgroundServices/  # Servi√ßos em background
‚îú‚îÄ‚îÄ Migrations/          # Migra√ß√µes do banco de dados
‚îú‚îÄ‚îÄ Dockerfile           # Configura√ß√£o Docker
‚îî‚îÄ‚îÄ docker-compose.yml   # Orquestra√ß√£o de containers

CreditoAPI.Tests/
‚îú‚îÄ‚îÄ Controllers/         # Testes dos controladores
‚îú‚îÄ‚îÄ Services/           # Testes dos servi√ßos
‚îî‚îÄ‚îÄ Repositories/       # Testes dos reposit√≥rios
```

## üìä Modelagem de Dados

```sql
CREATE TABLE credito
(
    id                BIGINT GENERATED BY DEFAULT AS IDENTITY,
    numero_credito    VARCHAR(50)    NOT NULL,
    numero_nfse       VARCHAR(50)    NOT NULL,
    data_constituicao DATE           NOT NULL,
    valor_issqn       DECIMAL(15, 2) NOT NULL,
    tipo_credito      VARCHAR(50)    NOT NULL,
    simples_nacional  BOOLEAN        NOT NULL,
    aliquota          DECIMAL(5, 2)  NOT NULL,
    valor_faturado    DECIMAL(15, 2) NOT NULL,
    valor_deducao     DECIMAL(15, 2) NOT NULL,
    base_calculo      DECIMAL(15, 2) NOT NULL
);
```

## üîå Endpoints da API

### 1. Integrar Cr√©ditos Constitu√≠dos

**POST** `/api/creditos/integrar-credito-constituido`

Envia cr√©ditos para o t√≥pico do Service Bus para processamento ass√≠ncrono.

**Request Body:**
```json
[
  {
    "numeroCredito": "123456",
    "numeroNfse": "7891011",
    "dataConstituicao": "2024-02-25",
    "valorIssqn": 1500.75,
    "tipoCredito": "ISSQN",
    "simplesNacional": "Sim",
    "aliquota": 5.0,
    "valorFaturado": 30000.00,
    "valorDeducao": 5000.00,
    "baseCalculo": 25000.00
  }
]
```

**Response:** `202 Accepted`
```json
{
  "success": true
}
```

### 2. Buscar Cr√©ditos por NFS-e

**GET** `/api/creditos/{numeroNfse}`

Retorna todos os cr√©ditos associados a uma NFS-e.

**Response:** `200 OK`
```json
[
  {
    "numeroCredito": "123456",
    "numeroNfse": "7891011",
    "dataConstituicao": "2024-02-25",
    "valorIssqn": 1500.75,
    "tipoCredito": "ISSQN",
    "simplesNacional": "Sim",
    "aliquota": 5.0,
    "valorFaturado": 30000.00,
    "valorDeducao": 5000.00,
    "baseCalculo": 25000.00
  }
]
```

### 3. Buscar Cr√©dito por N√∫mero

**GET** `/api/creditos/credito/{numeroCredito}`

Retorna os detalhes de um cr√©dito espec√≠fico.

**Response:** `200 OK`
```json
{
  "numeroCredito": "123456",
  "numeroNfse": "7891011",
  "dataConstituicao": "2024-02-25",
  "valorIssqn": 1500.75,
  "tipoCredito": "ISSQN",
  "simplesNacional": "Sim",
  "aliquota": 5.0,
  "valorFaturado": 30000.00,
  "valorDeducao": 5000.00,
  "baseCalculo": 25000.00
}
```

### 4. Health Check - Self

**GET** `/api/self`

Verifica se o servi√ßo est√° ativo.

**Response:** `200 OK`
```json
{
  "status": "healthy",
  "service": "CreditoAPI",
  "timestamp": "2024-02-25T10:30:00Z",
  "version": "1.0.0"
}
```

### 5. Health Check - Ready

**GET** `/api/ready`

Verifica se o servi√ßo est√° pronto (banco de dados conectado).

**Response:** `200 OK` ou `503 Service Unavailable`
```json
{
  "status": "Healthy",
  "checks": [
    {
      "name": "database",
      "status": "Healthy",
      "description": null,
      "duration": 45.2
    }
  ],
  "totalDuration": 45.2,
  "timestamp": "2024-02-25T10:30:00Z"
}
```

## üîß Configura√ß√£o e Instala√ß√£o

### Pr√©-requisitos

- [.NET 6.0 SDK](https://dotnet.microsoft.com/download/dotnet/6.0)
- [Docker Desktop](https://www.docker.com/products/docker-desktop)
- [Azure Service Bus](https://azure.microsoft.com/services/service-bus/) (opcional)

### Configura√ß√£o do Azure Service Bus

1. Crie um namespace do Service Bus no Azure
2. Crie um t√≥pico chamado `integrar-credito-constituido-entry`
3. Crie uma assinatura para o t√≥pico
4. Obtenha a connection string do Service Bus

### Vari√°veis de Ambiente

Edite o arquivo `appsettings.json` ou configure as vari√°veis de ambiente:

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Port=5432;Database=creditodb;Username=postgres;Password=postgres"
  },
  "ServiceBus": {
    "ConnectionString": "Endpoint=sb://your-namespace.servicebus.windows.net/;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=your-key",
    "TopicName": "integrar-credito-constituido-entry",
    "SubscriptionName": "credito-processor"
  },
  "BackgroundService": {
    "ProcessingIntervalMs": 500
  }
}
```

## üê≥ Executando com Docker

### Op√ß√£o 1: Docker Compose (Recomendado)

```bash
# Clone o reposit√≥rio
git clone <repository-url>
cd CreditoAPI

# Inicie os containers
docker-compose up -d

# Verifique os logs
docker-compose logs -f api

# Pare os containers
docker-compose down

# Pare e remova os volumes (dados do banco)
docker-compose down -v
```

A API estar√° dispon√≠vel em: `http://localhost:5000`

Swagger UI: `http://localhost:5000/swagger`

### Op√ß√£o 2: Docker Manual

```bash
# Build da imagem
docker build -t creditoapi .

# Execute o PostgreSQL
docker run -d \
  --name postgres \
  -e POSTGRES_PASSWORD=postgres \
  -e POSTGRES_DB=creditodb \
  -p 5432:5432 \
  postgres:14-alpine

# Execute a API
docker run -d \
  --name creditoapi \
  -p 5000:80 \
  -e ConnectionStrings__DefaultConnection="Host=postgres;Port=5432;Database=creditodb;Username=postgres;Password=postgres" \
  --link postgres:postgres \
  creditoapi
```

## üíª Executando Localmente (Sem Docker)

### 1. Instalar Depend√™ncias

```bash
cd CreditoAPI
dotnet restore
```

### 2. Configurar Banco de Dados

Certifique-se de que o PostgreSQL est√° rodando e atualize a connection string em `appsettings.json`.

### 3. Aplicar Migra√ß√µes

```bash
dotnet ef database update
```

### 4. Executar a API

```bash
dotnet run
```

A API estar√° dispon√≠vel em: `https://localhost:7000` ou `http://localhost:5000`

## üß™ Executando os Testes

### Todos os Testes

```bash
cd CreditoAPI.Tests
dotnet test
```

### Com Cobertura de C√≥digo

```bash
dotnet test /p:CollectCoverage=true /p:CoverletOutputFormat=opencover
```

### Testes Espec√≠ficos

```bash
# Testes de servi√ßos
dotnet test --filter "FullyQualifiedName~CreditoAPI.Tests.Services"

# Testes de reposit√≥rios
dotnet test --filter "FullyQualifiedName~CreditoAPI.Tests.Repositories"

# Testes de controladores
dotnet test --filter "FullyQualifiedName~CreditoAPI.Tests.Controllers"
```

## üîÑ Fluxo de Funcionamento

1. **Integra√ß√£o de Cr√©ditos:**
   - Cliente envia lista de cr√©ditos via POST `/api/creditos/integrar-credito-constituido`
   - API publica cada cr√©dito como mensagem individual no Azure Service Bus
   - Retorna status 202 (Accepted) imediatamente

2. **Processamento em Background:**
   - Background service verifica o Service Bus a cada 500ms
   - Recebe mensagens do t√≥pico
   - Valida se o cr√©dito j√° existe no banco (evita duplicatas)
   - Insere cr√©ditos novos no PostgreSQL de forma individual (n√£o bulk)

3. **Consulta de Cr√©ditos:**
   - Cliente pode consultar cr√©ditos por NFS-e ou n√∫mero do cr√©dito
   - API retorna dados diretamente do PostgreSQL

## üìù Padr√µes de Projeto Implementados

### 1. Repository Pattern
Abstra√ß√£o da camada de dados, facilitando testes e manuten√ß√£o.

```csharp
public interface ICreditoRepository
{
    Task<Credito?> GetByNumeroCreditoAsync(string numeroCredito);
    Task<List<Credito>> GetByNumeroNfseAsync(string numeroNfse);
    Task<Credito> AddAsync(Credito credito);
    Task<bool> ExistsAsync(string numeroCredito);
}
```

### 2. Dependency Injection
Todas as depend√™ncias s√£o injetadas via construtor.

```csharp
public class CreditoService : ICreditoService
{
    private readonly ICreditoRepository _repository;
    private readonly IServiceBusService _serviceBusService;
    private readonly ILogger<CreditoService> _logger;

    public CreditoService(
        ICreditoRepository repository,
        IServiceBusService serviceBusService,
        ILogger<CreditoService> logger)
    {
        _repository = repository;
        _serviceBusService = serviceBusService;
        _logger = logger;
    }
}
```

### 3. Background Service Pattern
Processamento ass√≠ncrono de mensagens.

```csharp
public class CreditoProcessorService : BackgroundService
{
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        while (!stoppingToken.IsCancellationRequested)
        {
            // Processa mensagens a cada 500ms
            await Task.Delay(_processingIntervalMs, stoppingToken);
        }
    }
}
```

### 4. DTO Pattern
Separa√ß√£o entre modelos de dom√≠nio e transfer√™ncia de dados.

## üîí Boas Pr√°ticas Implementadas

- ‚úÖ **SOLID Principles**
- ‚úÖ **Clean Code**
- ‚úÖ **Async/Await** para opera√ß√µes I/O
- ‚úÖ **Logging** estruturado
- ‚úÖ **Exception Handling** adequado
- ‚úÖ **Valida√ß√£o de dados**
- ‚úÖ **Health Checks**
- ‚úÖ **Containeriza√ß√£o**
- ‚úÖ **Testes Unit√°rios**
- ‚úÖ **Documenta√ß√£o Swagger**

## üìÅ Estrutura de Arquivos Criados

```
CreditoAPI/
‚îú‚îÄ‚îÄ CreditoAPI/
‚îÇ   ‚îú‚îÄ‚îÄ Controllers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CreditosController.cs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ HealthController.cs
‚îÇ   ‚îú‚îÄ‚îÄ Models/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Credito.cs
‚îÇ   ‚îú‚îÄ‚îÄ DTOs/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CreditoDto.cs
‚îÇ   ‚îú‚îÄ‚îÄ Data/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ApplicationDbContext.cs
‚îÇ   ‚îú‚îÄ‚îÄ Repositories/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ICreditoRepository.cs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CreditoRepository.cs
‚îÇ   ‚îú‚îÄ‚îÄ Services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ICreditoService.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CreditoService.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ IServiceBusService.cs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ServiceBusService.cs
‚îÇ   ‚îú‚îÄ‚îÄ BackgroundServices/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CreditoProcessorService.cs
‚îÇ   ‚îú‚îÄ‚îÄ Migrations/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 20240101000000_InitialCreate.cs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ApplicationDbContextModelSnapshot.cs
‚îÇ   ‚îú‚îÄ‚îÄ CreditoAPI.csproj
‚îÇ   ‚îú‚îÄ‚îÄ Program.cs
‚îÇ   ‚îú‚îÄ‚îÄ appsettings.json
‚îÇ   ‚îú‚îÄ‚îÄ appsettings.Development.json
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yml
‚îÇ   ‚îú‚îÄ‚îÄ .dockerignore
‚îÇ   ‚îî‚îÄ‚îÄ .gitignore
‚îÇ
‚îú‚îÄ‚îÄ CreditoAPI.Tests/
‚îÇ   ‚îú‚îÄ‚îÄ Controllers/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CreditosControllerTests.cs
‚îÇ   ‚îú‚îÄ‚îÄ Services/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CreditoServiceTests.cs
‚îÇ   ‚îú‚îÄ‚îÄ Repositories/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CreditoRepositoryTests.cs
‚îÇ   ‚îî‚îÄ‚îÄ CreditoAPI.Tests.csproj
‚îÇ
‚îú‚îÄ‚îÄ CreditoAPI.sln
‚îú‚îÄ‚îÄ README.md (Documenta√ß√£o completa)
‚îú‚îÄ‚îÄ SETUP.md (Guia de configura√ß√£o)
‚îú‚îÄ‚îÄ ARCHITECTURE.md (Documenta√ß√£o de arquitetura)
‚îú‚îÄ‚îÄ PROJECT_SUMMARY.md (Este arquivo)
‚îú‚îÄ‚îÄ test-requests.http (Exemplos de requisi√ß√µes)
‚îú‚îÄ‚îÄ database-setup.sql (Scripts SQL)
‚îî‚îÄ‚îÄ run-tests.ps1 (Script para executar testes)
```

## üèóÔ∏è Padr√µes de Projeto Implementados

1. **Repository Pattern** - Abstra√ß√£o de acesso a dados
2. **Dependency Injection** - Invers√£o de controle
3. **Background Service** - Processamento ass√≠ncrono
4. **DTO Pattern** - Separa√ß√£o de modelos
5. **Factory Pattern** - Via DI container
6. **Singleton Pattern** - ServiceBusService

## üé® Princ√≠pios SOLID Aplicados

- ‚úÖ **Single Responsibility** - Cada classe tem uma responsabilidade
- ‚úÖ **Open/Closed** - Aberto para extens√£o, fechado para modifica√ß√£o
- ‚úÖ **Liskov Substitution** - Interfaces substitu√≠veis
- ‚úÖ **Interface Segregation** - Interfaces espec√≠ficas
- ‚úÖ **Dependency Inversion** - Depend√™ncias de abstra√ß√µes

## üöÄ Como Executar

### Op√ß√£o 1: Docker (Mais R√°pido)

```bash
cd CreditoAPI
docker-compose up -d
```

Acesse: http://localhost:5000/swagger

### Op√ß√£o 2: Local

```bash
cd CreditoAPI
dotnet restore
dotnet ef database update
dotnet run
```

### Executar Testes

```bash
cd CreditoAPI.Tests
dotnet test
```

Ou use o script PowerShell:
```powershell
.\run-tests.ps1
```

## üìù Documenta√ß√£o Dispon√≠vel

1. **README.md** - Documenta√ß√£o principal completa
2. **test-requests.http** - Exemplos de requisi√ß√µes HTTP
3. **database-setup.sql** - Scripts SQL para setup manual

## üîç Endpoints Implementados

| M√©todo | Endpoint | Descri√ß√£o | Status |
|--------|----------|-----------|--------|
| POST | `/api/creditos/integrar-credito-constituido` | Integra cr√©ditos via Service Bus | 202 |
| GET | `/api/creditos/{numeroNfse}` | Busca cr√©ditos por NFS-e | 200/404 |
| GET | `/api/creditos/credito/{numeroCredito}` | Busca cr√©dito por n√∫mero | 200/404 |
| GET | `/api/self` | Health check b√°sico | 200 |
| GET | `/api/ready` | Health check completo | 200/503 |

## üß™ Testes Implementados

### CreditoServiceTests (6 testes)
- ‚úÖ IntegrarCreditosAsync_ShouldSendMessagesToServiceBus
- ‚úÖ GetByNumeroNfseAsync_ShouldReturnCreditos
- ‚úÖ GetByNumeroCreditoAsync_ShouldReturnCredito
- ‚úÖ GetByNumeroCreditoAsync_WhenNotFound_ShouldReturnNull
- ‚úÖ ProcessCreditoFromMessageAsync_ShouldInsertNewCredito
- ‚úÖ ProcessCreditoFromMessageAsync_WhenExists_ShouldNotInsert

### CreditoRepositoryTests (5 testes)
- ‚úÖ AddAsync_ShouldAddCreditoToDatabase
- ‚úÖ GetByNumeroCreditoAsync_ShouldReturnCredito
- ‚úÖ GetByNumeroNfseAsync_ShouldReturnMultipleCreditos
- ‚úÖ ExistsAsync_WhenExists_ShouldReturnTrue
- ‚úÖ ExistsAsync_WhenNotExists_ShouldReturnFalse

### CreditosControllerTests (6 testes)
- ‚úÖ IntegrarCreditoConstituido_WithValidData_ShouldReturnAccepted
- ‚úÖ IntegrarCreditoConstituido_WithEmptyList_ShouldReturnBadRequest
- ‚úÖ GetByNumeroNfse_WhenFound_ShouldReturnOk
- ‚úÖ GetByNumeroNfse_WhenNotFound_ShouldReturnNotFound
- ‚úÖ GetByNumeroCredito_WhenFound_ShouldReturnOk
- ‚úÖ GetByNumeroCredito_WhenNotFound_ShouldReturnNotFound

## üîß Tecnologias e Vers√µes

| Tecnologia | Vers√£o |
|------------|--------|
| .NET Core | 6.0 |
| C# | 10.0 |
| Entity Framework Core | 6.0.25 |
| Npgsql (PostgreSQL) | 6.0.22 |
| Azure Service Bus | 7.17.5 |
| MSTest | 2.2.10 |
| Moq | 4.18.4 |
| PostgreSQL | 14-alpine |
| Docker | Latest |

## üéØ Diferenciais Implementados

Al√©m dos requisitos b√°sicos, o projeto inclui:

- ‚úÖ **Scripts Auxiliares** - run-tests.ps1, database-setup.sql
- ‚úÖ **Swagger/OpenAPI** - Documenta√ß√£o interativa da API
- ‚úÖ **Logging Estruturado** - Em todas as opera√ß√µes
- ‚úÖ **Tratamento de Erros** - Completo e consistente
- ‚úÖ **Valida√ß√£o de Dados** - Data Annotations
- ‚úÖ **Health Checks** - Liveness e Readiness
- ‚úÖ **Docker Multi-Stage** - Build otimizado
- ‚úÖ **Volume Persistente** - Dados do PostgreSQL
- ‚úÖ **CORS Configurado** - Para integra√ß√£o frontend
- ‚úÖ **Migrations** - Versionamento do banco
- ‚úÖ **√çndices de Performance** - Otimiza√ß√£o de queries
- ‚úÖ **Coment√°rios no C√≥digo** - C√≥digo autodocumentado
- ‚úÖ **Exemplos de Requisi√ß√µes** - test-requests.http
- ‚úÖ **Views e Fun√ß√µes SQL** - Para an√°lises

## üèÜ Qualidade do C√≥digo

- ‚úÖ **Clean Code** - C√≥digo limpo e leg√≠vel
- ‚úÖ **DRY** - Don't Repeat Yourself
- ‚úÖ **KISS** - Keep It Simple, Stupid
- ‚úÖ **SOLID** - Todos os princ√≠pios aplicados
- ‚úÖ **Separation of Concerns** - Camadas bem definidas
- ‚úÖ **Testabilidade** - 100% test√°vel via DI
- ‚úÖ **Manutenibilidade** - F√°cil de manter e estender



# üèóÔ∏è ARQUITETURA CQRS

## üìê Vis√£o Geral da Arquitetura CQRS

Implementa CQRS (Command Query Responsibility Segregation) e diversos Design Patterns avan√ßados.

### Diagrama de Arquitetura
```
Controller -> MediatR -> Handler -> Repository -> Database
                |
                +-> Command/Query
```

### üéØ Benef√≠cios do CQRS

1. **Separa√ß√£o de Responsabilidades** - Leitura e escrita independentes
2. **Escalabilidade** - Pode escalar cada lado separadamente
3. **Testabilidade** - Handlers podem ser testados isoladamente
4. **Manutenibilidade** - C√≥digo mais organizado
5. **Performance** - Otimiza√ß√µes espec√≠ficas

## üîß Componentes CQRS

### Commands (Escrita)

- `IntegrarCreditosCommand` - Integra lista de creditos
- `ProcessarCreditoCommand` - Processa credito individual

### Queries (Leitura)

- `GetCreditoByNumeroQuery` - Busca credito por numero
- `GetCreditosByNfseQuery` - Busca creditos por NFS-e

### Handlers

Cada Command/Query tem seu Handler dedicado:
- `IntegrarCreditosCommandHandler` 
- `ProcessarCreditoCommandHandler` 
- `GetCreditoByNumeroQueryHandler` 
- `GetCreditosByNfseQueryHandler` 

### Validators

FluentValidation para valida√ß√£o robusta:
- `IntegrarCreditosCommandValidator` 
- `CreditoDtoValidator` 

## üé® Design Patterns Avan√ßados (CQRS)

### 1. CQRS Pattern
Separacao de comandos e consultas

### 2. Mediator Pattern
MediatR para desacoplar componentes

### 3. Repository Pattern
Abstracao de acesso a dados

### 4. Unit of Work Pattern
Gerenciamento de transacoes

### 5. Specification Pattern
Logica de consulta reutilizavel

### 6. Dependency Injection
Inversao de controle

### 7. Factory Pattern
Criacao de objetos via DI

### 8. Singleton Pattern
ServiceBusService como singleton

### 9. DTO Pattern
Separa√ß√£o de modelos

## ‚úÖ Princ√≠pios SOLID (Detalhado)

### S - Single Responsibility
Cada classe tem uma unica responsabilidade

### O - Open/Closed
Aberto para extensao, fechado para modificacao

### L - Liskov Substitution
Interfaces substituiveis

### I - Interface Segregation
Interfaces especificas e coesas

### D - Dependency Inversion
Depend√™ncias de abstra√ß√µes

## üìÅ Estrutura de Pastas (CQRS)

```
CreditoAPI/
‚îú‚îÄ‚îÄ Application/
‚îÇ   ‚îú‚îÄ‚îÄ Commands/           # CQRS Commands
‚îÇ   ‚îú‚îÄ‚îÄ Queries/            # CQRS Queries
‚îÇ   ‚îú‚îÄ‚îÄ Handlers/           # Command/Query Handlers
‚îÇ   ‚îî‚îÄ‚îÄ Validators/         # FluentValidation
‚îú‚îÄ‚îÄ Infrastructure/
‚îÇ   ‚îú‚îÄ‚îÄ UnitOfWork/         # Unit of Work Pattern
‚îÇ   ‚îî‚îÄ‚îÄ Specifications/     # Specification Pattern
‚îú‚îÄ‚îÄ Controllers/            # API Controllers
‚îú‚îÄ‚îÄ Models/                 # Domain Entities
‚îú‚îÄ‚îÄ DTOs/                   # Data Transfer Objects
‚îú‚îÄ‚îÄ Repositories/           # Repository Pattern
‚îú‚îÄ‚îÄ Services/               # Business Services
‚îî‚îÄ‚îÄ BackgroundServices/     # Background Workers
```

## üÜï Tecnologias Adicionadas (CQRS)

- **MediatR 12.2.0** - Implementa√ß√£o do Mediator Pattern
- **FluentValidation 11.9.0** - Valida√ß√£o expressiva
- **.NET 8.0** - Framework atualizado
- **Entity Framework Core 8.0** - ORM atualizado

## üí° Como Usar CQRS

### Exemplo de Command

```csharp
// Controller
var command = new IntegrarCreditosCommand(creditos);
var result = await _mediator.Send(command);
```

### Exemplo de Query

```csharp
// Controller
var query = new GetCreditoByNumeroQuery(numeroCredito);
var credito = await _mediator.Send(query);
```

---

# üöÄ FEATURES AVAN√áADAS

## ‚úÖ Implementa√ß√µes Completas

### üéØ Event Sourcing
- **Marten Event Store** - Armazenamento de todos os eventos do sistema
- **Eventos**: `CreditoIntegradoEvent`, `CreditoProcessadoEvent`, `CreditoConsultadoEvent`
- **Auditoria Completa** - Hist√≥rico completo de todas as opera√ß√µes
- **Event Replay** - Reconstruir estado a partir dos eventos
- **PostgreSQL Backend** - Usa PostgreSQL como storage

### üîÑ Saga Pattern
- **MassTransit** - Orquestra√ß√£o de transa√ß√µes distribu√≠das
- **Estados**: Integrando ‚Üí Processando ‚Üí Auditando ‚Üí Conclu√≠do
- **Retry Autom√°tico** - At√© 3 tentativas com backoff exponencial
- **Compensa√ß√£o** - Rollback autom√°tico em caso de falha
- **Azure Service Bus** - Integra√ß√£o com mensageria

### üõ°Ô∏è Circuit Breaker & Retry Policy (Polly)
- **Retry Policy** - 3 tentativas com backoff exponencial (2^n segundos)
- **Circuit Breaker** - 5 falhas antes de abrir, 30s de break
- **Timeout Policy** - 30 segundos por opera√ß√£o
- **Pol√≠tica Combinada** - Timeout ‚Üí Retry ‚Üí Circuit Breaker
- **Logging Detalhado** - Logs em cada tentativa e mudan√ßa de estado

### üíæ Redis Caching (Avan√ßado)
- **Cache Distribu√≠do** - Compartilhado entre m√∫ltiplas inst√¢ncias
- **TTL Configur√°vel** - Expira√ß√£o autom√°tica (padr√£o: 5 minutos)
- **Cache-Aside Pattern** - Aplica√ß√£o gerencia o cache
- **Performance** - Redu√ß√£o de 80-90% no tempo de resposta
- **Serializa√ß√£o JSON** - Suporte a objetos complexos

### üåê API Gateway (Ocelot)
- **Roteamento Inteligente** - Mapeamento upstream/downstream
- **Rate Limiting** - 100 requisi√ß√µes/minuto por IP
- **Load Balancing** - Round Robin entre inst√¢ncias
- **QoS** - Circuit Breaker e Timeout integrados
- **Caching** - Cache de respostas por 30 segundos
- **Gateway URL**: `http://localhost:5001/gateway/*`



# üìö DOCUMENTA√á√ÉO DETALHADA DAS FEATURES AVAN√áADAS

## üéØ Event Sourcing

### Vis√£o Geral

Event Sourcing √© um padr√£o onde todas as mudan√ßas no estado da aplica√ß√£o s√£o armazenadas como uma sequ√™ncia de eventos. Em vez de armazenar apenas o estado atual, armazenamos todos os eventos que levaram a esse estado.

### Implementa√ß√£o

Utilizamos **Marten** como Event Store, que usa PostgreSQL como backend.

#### Eventos Dispon√≠veis

```csharp
// Evento de integra√ß√£o de cr√©dito
CreditoIntegradoEvent - Disparado quando um cr√©dito √© integrado
CreditoProcessadoEvent - Disparado quando um cr√©dito √© processado
CreditoConsultadoEvent - Disparado quando um cr√©dito √© consultado
```

#### Como Usar

```csharp
// Injetar o IEventStore
public class MeuService
{
    private readonly IEventStore _eventStore;
    
    public MeuService(IEventStore eventStore)
    {
        _eventStore = eventStore;
    }
    
    // Salvar evento
    public async Task IntegrarCredito(CreditoDto credito)
    {
        var evento = new CreditoIntegradoEvent
        {
            NumeroCredito = credito.NumeroCredito,
            NumeroNfse = credito.NumeroNfse,
            ValorIssqn = credito.ValorIssqn,
            // ... outros campos
        };
        
        await _eventStore.SaveEventAsync(evento);
    }
    
    // Recuperar eventos
    public async Task<IEnumerable<CreditoIntegradoEvent>> ObterEventos()
    {
        return await _eventStore.GetEventsAsync<CreditoIntegradoEvent>();
    }
}
```

### Benef√≠cios

- ‚úÖ **Auditoria Completa** - Hist√≥rico completo de todas as opera√ß√µes
- ‚úÖ **Debugging** - Possibilidade de reproduzir bugs
- ‚úÖ **An√°lise Temporal** - Consultar estado em qualquer ponto no tempo
- ‚úÖ **Event Replay** - Reconstruir estado a partir dos eventos

---

## üîÑ Saga Pattern

### Vis√£o Geral

O Saga Pattern gerencia transa√ß√µes distribu√≠das de longa dura√ß√£o, coordenando m√∫ltiplos servi√ßos e garantindo consist√™ncia eventual.

### Implementa√ß√£o

Utilizamos **MassTransit** para orquestra√ß√£o de sagas com Azure Service Bus.

#### Estados da Saga

```
Inicial ‚Üí Integrando ‚Üí Processando ‚Üí Auditando ‚Üí Conclu√≠do
                            ‚Üì
                         Falhou (com retry autom√°tico)
```

#### Fluxo da Saga

1. **IntegrarCredito** - Inicia a saga
2. **ProcessarCredito** - Processa o cr√©dito no banco
3. **AuditarCredito** - Registra auditoria
4. **Conclu√≠do** - Finaliza com sucesso

#### Retry Autom√°tico

- At√© **3 tentativas** em caso de falha
- Backoff exponencial entre tentativas
- Transi√ß√£o para estado "Falhou" ap√≥s 3 tentativas

### Comandos e Eventos

```csharp
// Comandos
IntegrarCreditoCommand
ProcessarCreditoCommand
AuditarCreditoCommand

// Eventos
CreditoProcessadoEvent
CreditoFalhouEvent
```

### Benef√≠cios

- ‚úÖ **Transa√ß√µes Distribu√≠das** - Coordena√ß√£o entre m√∫ltiplos servi√ßos
- ‚úÖ **Compensa√ß√£o Autom√°tica** - Rollback em caso de falha
- ‚úÖ **Resili√™ncia** - Retry autom√°tico com backoff
- ‚úÖ **Rastreabilidade** - Estado completo da transa√ß√£o

---

## üõ°Ô∏è Circuit Breaker & Retry Policy (Detalhado)

### Vis√£o Geral

Implementa√ß√£o de resili√™ncia usando **Polly** com Circuit Breaker, Retry Policy e Timeout.

### Pol√≠ticas Implementadas

#### 1. Retry Policy
```csharp
- Tentativas: 3
- Backoff: Exponencial (2^n segundos)
- Logging: Detalhado em cada retry
```

#### 2. Circuit Breaker
```csharp
- Falhas antes de abrir: 5
- Dura√ß√£o do break: 30 segundos
- Estados: Closed ‚Üí Open ‚Üí Half-Open ‚Üí Closed
```

#### 3. Timeout Policy
```csharp
- Timeout padr√£o: 30 segundos
- Estrat√©gia: Pessimistic
```

### Pol√≠tica Combinada

As pol√≠ticas s√£o aplicadas na ordem:
```
Timeout ‚Üí Retry ‚Üí Circuit Breaker
```

### Uso no Service Bus

```csharp
// Automaticamente aplicado ao IServiceBusService
public class ResilientServiceBusService : IServiceBusService
{
    // Todas as chamadas passam pelas pol√≠ticas de resili√™ncia
    await _policy.ExecuteAsync(async () =>
    {
        await _innerService.SendMessageAsync(message);
    });
}
```

### Benef√≠cios

- ‚úÖ **Resili√™ncia** - Sistema continua operando mesmo com falhas tempor√°rias
- ‚úÖ **Prote√ß√£o** - Evita sobrecarga de servi√ßos com problemas
- ‚úÖ **Recovery Autom√°tico** - Tenta se recuperar automaticamente
- ‚úÖ **Observabilidade** - Logs detalhados de todas as tentativas

---

## üíæ Redis Caching (Detalhado)

### Vis√£o Geral

Cache distribu√≠do usando **Redis** para melhorar performance e reduzir carga no banco de dados.

### Implementa√ß√£o

```csharp
public interface ICacheService
{
    Task<T?> GetAsync<T>(string key);
    Task SetAsync<T>(string key, T value, TimeSpan? expiration = null);
    Task RemoveAsync(string key);
    Task<bool> ExistsAsync(string key);
}
```

### Uso nos Controllers

```csharp
[HttpGet("{numeroNfse}")]
public async Task<IActionResult> GetByNumeroNfse(string numeroNfse)
{
    var cacheKey = $"creditos:nfse:{numeroNfse}";
    
    // Tentar obter do cache
    var cached = await _cacheService.GetAsync<List<CreditoDto>>(cacheKey);
    if (cached != null)
    {
        return Ok(cached);
    }
    
    // Buscar do banco
    var creditos = await _mediator.Send(new GetCreditosByNfseQuery(numeroNfse));
    
    // Armazenar no cache (5 minutos)
    await _cacheService.SetAsync(cacheKey, creditos, TimeSpan.FromMinutes(5));
    
    return Ok(creditos);
}
```

### Estrat√©gias de Cache

- **Cache-Aside** - Aplica√ß√£o gerencia o cache
- **TTL** - Expira√ß√£o autom√°tica (padr√£o: 5 minutos)
- **Invalida√ß√£o** - Remover cache ap√≥s updates

### Benef√≠cios

- ‚úÖ **Performance** - Redu√ß√£o de 80-90% no tempo de resposta
- ‚úÖ **Escalabilidade** - Menos carga no banco de dados
- ‚úÖ **Distribu√≠do** - Compartilhado entre m√∫ltiplas inst√¢ncias
- ‚úÖ **Persist√™ncia** - Dados sobrevivem a reinicializa√ß√µes

---

## üåê API Gateway (Detalhado)

### Vis√£o Geral

API Gateway usando **Ocelot** para roteamento, rate limiting, caching e load balancing.

### Configura√ß√£o

```json
{
  "Routes": [
    {
      "DownstreamPathTemplate": "/api/v1/creditos/{everything}",
      "UpstreamPathTemplate": "/gateway/creditos/{everything}",
      "RateLimitOptions": {
        "EnableRateLimiting": true,
        "Period": "1m",
        "Limit": 100
      },
      "QoSOptions": {
        "ExceptionsAllowedBeforeBreaking": 3,
        "DurationOfBreak": 30000,
        "TimeoutValue": 10000
      },
      "LoadBalancerOptions": {
        "Type": "RoundRobin"
      },
      "FileCacheOptions": {
        "TtlSeconds": 30
      }
    }
  ]
}
```

### Features do Gateway

#### 1. Roteamento
- Mapeamento de rotas upstream/downstream
- Suporte a path parameters e query strings

#### 2. Rate Limiting
- 100 requisi√ß√µes por minuto por IP
- Resposta 429 quando excedido

#### 3. QoS (Quality of Service)
- Circuit Breaker integrado
- Timeout de 10 segundos
- 3 falhas antes de abrir o circuito

#### 4. Load Balancing
- Round Robin entre m√∫ltiplas inst√¢ncias
- Health checks autom√°ticos

#### 5. Caching
- Cache de respostas por 30 segundos
- Reduz carga nos servi√ßos downstream

### Endpoints do Gateway

```
Gateway Base URL: http://localhost:5001

/gateway/creditos/{everything}  ‚Üí API de Cr√©ditos
/gateway/health/self            ‚Üí Health Check Self
/gateway/health/ready           ‚Üí Health Check Ready
```

### Benef√≠cios

- ‚úÖ **Ponto √önico de Entrada** - Simplifica arquitetura de clientes
- ‚úÖ **Seguran√ßa** - Centraliza√ß√£o de autentica√ß√£o e autoriza√ß√£o
- ‚úÖ **Rate Limiting** - Prote√ß√£o contra abuso
- ‚úÖ **Load Balancing** - Distribui√ß√£o de carga
- ‚úÖ **Caching** - Redu√ß√£o de lat√™ncia

---

## ‚öôÔ∏è Configura√ß√£o Completa

### appsettings.json

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Port=5432;Database=creditodb;Username=postgres;Password=postgres",
    "Redis": "localhost:6379",
    "EventStore": "Host=localhost;Port=5432;Database=eventstore;Username=postgres;Password=postgres"
  },
  "ServiceBus": {
    "ConnectionString": "Endpoint=sb://...",
    "TopicName": "integrar-credito-constituido-entry",
    "SubscriptionName": "credito-processor"
  },
  "JwtSettings": {
    "Secret": "your-super-secret-key-min-32-characters-long",
    "Issuer": "CreditoAPI",
    "Audience": "CreditoAPIUsers",
    "ExpirationMinutes": 60
  },
  "IpRateLimiting": {
    "EnableEndpointRateLimiting": true,
    "StackBlockedRequests": false,
    "RealIpHeader": "X-Real-IP",
    "ClientIdHeader": "X-ClientId",
    "HttpStatusCode": 429,
    "GeneralRules": [
      {
        "Endpoint": "*",
        "Period": "1m",
        "Limit": 100
      }
    ]
  }
}
```

### Docker Compose Completo

```yaml
services:
  postgres:
    image: postgres:14-alpine
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: creditodb
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  api:
    build: .
    ports:
      - "5000:80"
    environment:
      - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=creditodb;Username=postgres;Password=postgres
      - ConnectionStrings__Redis=redis:6379
      - ConnectionStrings__EventStore=Host=postgres;Port=5432;Database=eventstore;Username=postgres;Password=postgres
    depends_on:
      - postgres
      - redis

  gateway:
    build: .
    ports:
      - "5001:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
    depends_on:
      - api

volumes:
  postgres_data:
  redis_data:
```

---

## üöÄ Como Executar

### 1. Com Docker Compose

```bash
# Iniciar todos os servi√ßos
docker-compose up -d

# Verificar logs
docker-compose logs -f

# Parar servi√ßos
docker-compose down
```

### 2. Localmente

```bash
# Instalar depend√™ncias
dotnet restore

# Aplicar migra√ß√µes
dotnet ef database update

# Executar
dotnet run
```

### 3. Acessar Servi√ßos

- **API**: http://localhost:5000
- **Gateway**: http://localhost:5001
- **Swagger**: http://localhost:5000/swagger
- **Prometheus**: http://localhost:9090
- **Grafana**: http://localhost:3000

---

## üìö Refer√™ncias

- [Marten - Event Store](https://martendb.io/)
- [MassTransit - Saga Pattern](https://masstransit-project.com/)
- [Polly - Resilience](https://github.com/App-vNext/Polly)
- [Ocelot - API Gateway](https://ocelot.readthedocs.io/)
- [Redis - Caching](https://redis.io/)

---

**Desenvolvido com as melhores pr√°ticas de arquitetura de software.**

